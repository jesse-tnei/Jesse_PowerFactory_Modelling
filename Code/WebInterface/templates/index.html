<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerFactory Control Panel</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- SocketIO for real-time updates -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="text-center">PowerFactory Analysis Control Panel</h3>
                    </div>
                    <div class="card-body">
                        <!-- Status Display -->
                        <div id="status-display" class="alert alert-info mb-4">
                            <strong>Status:</strong> <span id="status-text">Ready</span>
                        </div>
                        
                        <!-- Progress Bar (hidden initially) -->
                        <div id="progress-container" class="mb-4" style="display: none;">
                            <div class="progress">
                                <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <!-- Control Buttons -->
                        <div class="d-grid gap-3">
                            <button id="run-loadflow-btn" class="btn btn-primary btn-lg">
                                <i class="bi bi-play-circle"></i> Run Load Flow Analysis
                            </button>
                            <button id="generate-map-btn" class="btn btn-success btn-lg" disabled>
                                <i class="bi bi-map"></i> Generate Voltage Map
                            </button>
                        </div>
                        
                        <!-- Results Display -->
                        <div id="results-container" class="mt-4" style="display: none;">
                            <h5>Analysis Results:</h5>
                            <div id="results-content" class="alert alert-light">
                                <!-- Results will be populated here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Your custom JavaScript -->
    <script>
        // Initialize SocketIO connection
        const socket = io();
        
        // Get button elements
        const loadFlowBtn = document.getElementById('run-loadflow-btn');
        const generateMapBtn = document.getElementById('generate-map-btn');
        const statusText = document.getElementById('status-text');
        const progressContainer = document.getElementById('progress-container');
        const progressBar = document.getElementById('progress-bar');
        
        // Button click handlers
        loadFlowBtn.addEventListener('click', runLoadFlow);
        generateMapBtn.addEventListener('click', generateMap);
        
        // Socket event handlers
        socket.on('connect', function() {
            statusText.textContent = 'Connected to PowerFactory Framework';
        });
        
        function runLoadFlow() {
            // Disable button and show progress
            loadFlowBtn.disabled = true;
            loadFlowBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Running...';
            statusText.textContent = 'Running load flow analysis...';
            progressContainer.style.display = 'block';
            
            // Send request to Flask backend
            fetch('/api/loadflow/run', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusText.textContent = 'Load flow analysis completed successfully!';
                    generateMapBtn.disabled = false; // Enable next button
                    loadFlowBtn.innerHTML = '<i class="bi bi-check-circle"></i> Load Flow Complete';
                    loadFlowBtn.className = 'btn btn-outline-success btn-lg';
                } else {
                    statusText.textContent = 'Error: ' + data.message;
                    loadFlowBtn.innerHTML = '<i class="bi bi-exclamation-circle"></i> Try Again';
                    loadFlowBtn.disabled = false;
                }
                progressContainer.style.display = 'none';
            })
            .catch(error => {
                statusText.textContent = 'Error: ' + error.message;
                loadFlowBtn.disabled = false;
                loadFlowBtn.innerHTML = '<i class="bi bi-play-circle"></i> Run Load Flow Analysis';
                progressContainer.style.display = 'none';
            });
        }
        
        function generateMap() {
            generateMapBtn.disabled = true;
            generateMapBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Generating...';
            statusText.textContent = 'Generating voltage visualization map...';
            
            fetch('/api/visualization/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    statusText.textContent = 'Voltage map generated successfully!';
                    generateMapBtn.innerHTML = '<i class="bi bi-check-circle"></i> Map Generated';
                    generateMapBtn.className = 'btn btn-outline-success btn-lg';
                } else {
                    statusText.textContent = 'Error: ' + data.message;
                    generateMapBtn.innerHTML = '<i class="bi bi-exclamation-circle"></i> Try Again';
                    generateMapBtn.disabled = false;
                }
            })
            .catch(error => {
                statusText.textContent = 'Error: ' + error.message;
                generateMapBtn.disabled = false;
                generateMapBtn.innerHTML = '<i class="bi bi-map"></i> Generate Voltage Map';
            });
        }
    </script>
</body>
</html>