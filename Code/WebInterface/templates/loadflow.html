<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Basic Load Flow - PowerFactory</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .workflow-container {
            max-width: 100%;
        }
        
        .step-container {
            opacity: 1;
            transition: opacity 0.3s ease-in-out;
        }
        
        .step-container.d-none {
            opacity: 0;
        }
        
        .engine-select-btn {
            transition: all 0.3s ease;
            border: 2px solid;
        }
        
        .engine-select-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .badge {
            font-size: 0.9rem;
        }
        
        .card {
            border: 1px solid rgba(255,255,255,0.1);
            background-color: rgba(255,255,255,0.05);
        }
        
        .card-body {
            background-color: transparent;
        }
        
        .form-control {
            background-color: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
        }
        
        .form-control:focus {
            background-color: rgba(255,255,255,0.15);
            border-color: #0d6efd;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
            color: white;
        }
        
        .form-control::placeholder {
            color: rgba(255,255,255,0.6);
        }
        
        .form-text {
            color: rgba(255,255,255,0.7);
        }
        
        .alert-info {
            background-color: rgba(13, 202, 240, 0.1);
            border-color: rgba(13, 202, 240, 0.2);
            color: #b6effb;
        }
        
        .text-muted {
            color: rgba(255,255,255,0.7) !important;
        }
        
        .spinner-border-sm {
            width: 1rem;
            height: 1rem;
        }
        
        .loadflow-icon {
            max-width: 120px;
            max-height: 60px;
            width: auto;
            height: auto;
            object-fit: contain;
            padding: 12px 20px;
            background: linear-gradient(135deg, 
                rgba(255, 255, 255, 0.9) 0%, 
                rgba(240, 240, 240, 0.8) 50%, 
                rgba(220, 220, 220, 0.7) 100%);
            border-radius: 25px;
            box-shadow: 
                0 4px 15px rgba(255, 255, 255, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.8),
                inset 0 -1px 0 rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
            filter: brightness(1.1);
        }
        
        .loadflow-icon:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 6px 20px rgba(255, 255, 255, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.9),
                inset 0 -1px 0 rgba(0, 0, 0, 0.15);
            filter: brightness(1.2);
        }
        
        .result-icon {
            max-width: 2.5rem;
            max-height: 2.5rem;
            width: auto;
            height: auto;
            object-fit: contain;
            filter: brightness(1.1);
            transition: all 0.3s ease;
        }
        
        .result-icon:hover {
            filter: brightness(1.3) saturate(1.2);
            transform: scale(1.1);
        }
        
        .svg-icon {
            transition: all 0.3s ease;
        }
        
        .card:hover .result-icon {
            filter: brightness(1.4) saturate(1.3);
        }
    </style>
</head>
<body class = 'loadflow-dark-theme'>
<div id="container-loadflow"></div>
<!-- Content -->
<div class="container content-space-2 content-space-lg-3">
  <div class="row">
    <div class="col-md-4 col-lg-3 mb-9 mb-md-0">
      <div class="pe-lg-2">
        <div class="text-center mb-4">
          <img class="loadflow-icon" src="{{ url_for('static', filename='images/icons/LoadFlow2.png') }}" alt="Load Flow Icon">
        </div>

        <div class="mb-7">
          <h1 class="h4">Categories</h1>
          <a class="tag-glossy tag-purple me-1 mb-2" href="#">Network Studies</a>
          <a class="tag-glossy tag-blue me-1 mb-2" href="#">Transmission</a>
          <a class="tag-glossy tag-green me-1 mb-2" href="#">Load Flow</a>
          <a class="tag-glossy tag-purple me-1 mb-2" href="#">Contingency</a>
        </div>
      <div class="d-none d-md-block mb-7">
        <h4>Development Team</h4>
        
        <!-- Engineering Consultant -->
        <div class="mb-1">
          <h6 class=" small mb-1">ENGINEERING CONSULTANT</h6>
          <div class="d-flex mb-1">
            <div class="flex-shrink-0">
            </div>
            <div class="flex-grow-1 ms-2">
              <p class="mb-0 align-items-left fw-medium text-white">John Smith</p>
              <a class="link text" href="https://linkedin.com/in/johnsmith" target="_blank" style="font-size: 0.7rem;">
                <i class="bi-linkedin me-1"></i> LinkedIn
              </a>
            </div>
          </div>
        </div>

        <!-- Technical Developer -->
        <div class="mb-1">
          <h6 class="small mb-1">TECHNICAL DEVELOPER</h6>
          <div class="d-flex align-items-left mb-1">
            <div class="flex-shrink-0">
            </div>
            <div class="flex-grow-1 ms-2">
              <p class="mb-0 align-items-left fw-medium text-white">Jane Doe</p>
              <a class="link " href="https://linkedin.com/in/janedoe" target="_blank" style="font-size: 0.7rem;">
                <i class="bi-linkedin me-1"></i> LinkedIn
              </a>
            </div>
          </div>
        </div>

        <!-- Research Contributions -->
        <div class="mb-1">
          <h6 class="small mb-1">RESEARCH CONTRIBUTIONS</h6>
          <!-- Researcher 1 -->
          <div class="d-flex align-items-center mb-1">
            <div class="flex-shrink-0">
            </div>
            <div class="flex-grow-1 ms-2">
              <p class="mb-0 align-items-left text-white">Dr. Sarah Wilson</p>
              <a class="link" href="https://linkedin.com/in/sarahwilson" target="_blank" style="font-size: 0.7rem;">
                <i class="bi-linkedin me-1"></i> LinkedIn
              </a>
            </div>
          </div>

          <!-- Researcher 2 -->
          <div class="d-flex align-items-left">
            <div class="flex-shrink-0">
            </div>
            <div class="flex-grow-1 ms-2">
              <p class="mb-0 fw-medium text-white">Prof. Michael Chen</p>
              <a class="link text" href="https://linkedin.com/in/michaelchen" target="_blank" style="font-size: 0.7rem;">
                <i class="bi-linkedin me-1"></i> LinkedIn
              </a>
            </div>
          </div>
        </div>
      </div>
        <div class="d-none d-md-block mb-7">
          <h4>Website</h4>

          <a class="link" href="#">https://www.google.com/drive/</a>
        </div>

        <div class="d-none d-md-block mb-7">
          <h4>Developer links</h4>

          <!-- List Pointer -->
          <ul class="list-unstyled list-pointer">
            <li class="list-pointer-item">
              <a class="link link-secondary" href="#">Support</a>
            </li>
            <li class="list-pointer-item">
              <a class="link link-secondary" href="#">Documentation</a>
            </li>
            <li class="list-pointer-item">
              <a class="link link-secondary" href="#">Privacy Policy</a>
            </li>
          </ul>
          <!-- End List Pointer -->
        </div>

        <a class="link-sm link-secondary" href="#">
          <i class="bi-flag me-2"></i> Report abuse
        </a>
      </div>
    </div>
    <!-- End Col -->

    <div class="col-md-8 col-lg-9 column-divider-md">
      <div class="ps-lg-2">
        <!-- Nav Scroller -->
        <div class="js-nav-scroller hs-nav-scroller-horizontal">
          <span class="hs-nav-scroller-arrow-prev" style="display: none;">
            <a class="hs-nav-scroller-arrow-link" href="javascript:;">
              <i class="bi-chevron-left"></i>
            </a>
          </span>

          <span class="hs-nav-scroller-arrow-next" style="display: none;">
            <a class="hs-nav-scroller-arrow-link" href="javascript:;">
              <i class="bi-chevron-right"></i>
            </a>
          </span>

          <!-- Nav -->
        <ul class="nav nav-dark-theme nav-fill mb-7" id="featuresTab" role="tablist">
            <li class="nav-item" role="presentation">
                <a class="nav-link nav-link-purple active" href="#featuresOne" id="featuresOne-tab" data-bs-toggle="tab" data-bs-target="#featuresOne" role="tab" aria-controls="featuresOne" aria-selected="true" style="min-width: 7rem;">About</a>
            </li>

            <li class="nav-item" role="presentation">
                <a class="nav-link nav-link-purple" href="#featuresTwo" id="featuresTwo-tab" data-bs-toggle="tab" data-bs-target="#featuresTwo" role="tab" aria-controls="featuresTwo" aria-selected="false" style="min-width: 7rem;">Run Study</a>
            </li>

            <li class="nav-item" role="presentation">
                <a class="nav-link nav-link-purple" href="#featuresThree" id="featuresThree-tab" data-bs-toggle="tab" data-bs-target="#featuresThree" role="tab" aria-controls="featuresThree" aria-selected="false" style="min-width: 7rem;">Review Results</a>
            </li>
        </ul>
          <!-- End Nav -->
        </div>
        <!-- End Nav Scroller -->

        <!-- Tab Content -->
        <div class="tab-content" id="pills-tabContent">
          <div class="tab-pane fade show active" id="featuresOne" role="tabpanel" aria-labelledby="featuresOne-tab">
            <h4 class="mb-4">LoadFlow Analysis Tool</h4>
            
            <p class="mb-4">
              The LoadFlow module provides power system engineers with a comprehensive web-based platform for conducting electrical network analysis using industry-standard simulation engines. Users can seamlessly choose between two powerful analysis engines: <strong>PowerFactory</strong> for advanced power system modeling and <strong>IPSA</strong> for specialized network studies. The intuitive workflow guides users through a four-step process: selecting their preferred analysis engine, initializing the computational backend, configuring engine-specific settings (including network file specification for IPSA), and executing the load flow calculations.
            </p>
            
            <p class="mb-4">
              This tool bridges the gap between complex power system analysis software and user-friendly web interfaces, enabling engineers to perform critical network studies without requiring deep technical knowledge of the underlying simulation engines. The platform automatically handles engine initialization, provides real-time status feedback throughout the analysis process, and prepares results for visualization in multiple formats. Whether analyzing transmission networks, distribution systems, or conducting contingency studies, the LoadFlow tool streamlines the entire workflow from data input to results interpretation, making sophisticated power system analysis accessible through a modern web interface.
            </p>

            <h5 class="mb-3">Key Features:</h5>
            <ul class="list-unstyled list-pointer mb-5">
              <li class="list-pointer-item">Multi-engine support (PowerFactory & IPSA)</li>
              <li class="list-pointer-item">Progressive workflow design with step-by-step guidance</li>
              <li class="list-pointer-item">Automated engine initialization and configuration</li>
              <li class="list-pointer-item">Network file handling for IPSA XML files</li>
              <li class="list-pointer-item">Real-time status feedback and error handling</li>
              <li class="list-pointer-item">Results visualization in multiple formats</li>
              <li class="list-pointer-item">Web-based accessibility from any modern browser</li>
              <li class="list-pointer-item">Seamless integration with existing power system workflows</li>
            </ul>
          </div>

          <div class="tab-pane fade" id="featuresTwo" role="tabpanel" aria-labelledby="featuresTwo-tab">
            <!-- Load Flow Workflow Section -->
            <div class="workflow-container">
              <!-- Step 1: Engine Selection -->
              <div class="step-container mb-4" id="step-engine-selection">
                <h5 class="mb-3">
                  <span class="badge bg-primary rounded-pill me-2">1</span>
                  Select Analysis Engine
                </h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <div class="d-grid">
                      <button class="btn btn-outline-primary btn-lg engine-select-btn" 
                              data-engine="powerfactory" 
                              onclick="selectEngine('powerfactory')">
                        <i class="bi-lightning me-2"></i>PowerFactory
                      </button>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="d-grid">
                      <button class="btn btn-outline-primary btn-lg engine-select-btn" 
                              data-engine="ipsa" 
                              onclick="selectEngine('ipsa')">
                        <i class="bi-cpu me-2"></i>IPSA
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 2: Engine Initialization -->
              <div class="step-container mb-4 d-none" id="step-engine-init">
                <h5 class="mb-3">
                  <span class="badge bg-secondary rounded-pill me-2">2</span>
                  Initialize Engine
                </h5>
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                      <div>
                        <h6 class="card-title mb-1" id="selected-engine-name">Engine</h6>
                        <p class="card-text text-muted mb-0" id="engine-status">Ready to initialize</p>
                      </div>
                      <div>
                        <button class="btn btn-primary" onclick="initializeEngine()" id="init-engine-btn">
                          <i class="bi-power me-2"></i>Initialize
                        </button>
                      </div>
                    </div>
                    <!-- Progress/Status Indicator -->
                    <div class="mt-3 d-none" id="engine-status-indicator">
                      <div class="d-flex align-items-center">
                        <div class="spinner-border spinner-border-sm me-2" role="status" id="init-spinner">
                          <span class="visually-hidden">Loading...</span>
                        </div>
                        <span id="status-text">Initializing engine...</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 3: Engine-Specific Configuration -->
              <div class="step-container mb-4 d-none" id="step-engine-config">
                <h5 class="mb-3">
                  <span class="badge bg-secondary rounded-pill me-2">3</span>
                  Engine Configuration
                </h5>
                
                <!-- IPSA Configuration -->
                <div class="card d-none" id="ipsa-config">
                  <div class="card-body">
                    <h6 class="card-title">IPSA File Selection</h6>
                    <div class="mb-3">
                      <label for="ipsa-file-path" class="form-label">Path to IPSA File</label>
                      <div class="input-group">
                        <input type="text" class="form-control" id="ipsa-file-path" 
                               placeholder="Enter path to .xml file or browse...">
                        <button class="btn btn-outline-secondary" type="button" onclick="browseFile()">
                          <i class="bi-folder me-1"></i>Browse
                        </button>
                      </div>
                      <div class="form-text">Select the IPSA XML file for load flow analysis</div>
                    </div>
                    <div class="d-grid">
                      <button class="btn btn-success" onclick="loadIPSAFile()" id="load-ipsa-btn">
                        <i class="bi-file-earmark-check me-2"></i>Load IPSA File
                      </button>
                    </div>
                  </div>
                </div>

                <!-- PowerFactory Configuration -->
                <div class="card d-none" id="powerfactory-config">
                  <div class="card-body">
                    <h6 class="card-title">PowerFactory Connection</h6>
                    <div class="alert alert-info">
                      <i class="bi-info-circle me-2"></i>
                      PowerFactory engine is ready. No additional configuration required.
                    </div>
                    <div class="d-grid">
                      <button class="btn btn-success" onclick="configurePowerFactory()" id="config-pf-btn">
                        <i class="bi-check-circle me-2"></i>Confirm Configuration
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 4: Run Load Flow Analysis -->
              <div class="step-container mb-4 d-none" id="step-run-analysis">
                <h5 class="mb-3">
                  <span class="badge bg-success rounded-pill me-2">4</span>
                  Run Load Flow Analysis
                </h5>
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between">
                      <div>
                        <h6 class="card-title mb-1">Ready to Run Analysis</h6>
                        <p class="card-text text-muted mb-0">All configurations completed successfully</p>
                      </div>
                      <div>
                        <button class="btn btn-lg btn-success" onclick="runLoadFlowAnalysis()" id="run-analysis-btn">
                          <i class="bi-play-circle me-2"></i>Run Load Flow Analysis
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Analysis Progress -->
              <div class="step-container d-none" id="step-analysis-progress">
                <div class="card">
                  <div class="card-body text-center">
                    <div class="spinner-border text-primary mb-3" role="status">
                      <span class="visually-hidden">Running analysis...</span>
                    </div>
                    <h6>Running Load Flow Analysis</h6>
                    <p class="text-muted">Please wait while the analysis is being performed...</p>
                  </div>
                </div>
              </div>
            </div>
            <!-- End Load Flow Workflow Section -->
          </div>

          <div class="tab-pane fade" id="featuresThree" role="tabpanel" aria-labelledby="featuresThree-tab">
            <h4 class="mb-3">Results Visualization</h4>

            <!-- Form -->
            <form>
              <div class="d-grid gap-2 mb-5">
                <!-- Card -->
                <div class="card card-sm card-bordered shadow-none">
                  <div class="card-body">
                    <div class="row align-items-sm-center">
                      <div class="col">
                        <div class="d-flex align-items-center">
                          <div class="flex-shrink-0">
                            <span class="svg-icon svg-icon-sm text-center text-primary d-flex align-items-center justify-content-center" style="min-width: 3rem; height: 3rem;">
                              <img src="{{ url_for('static', filename='images/icons/LoadFlow.png') }}" alt="Generate Plots" class="result-icon">
                            </span>
                          </div>

                          <div class="flex-grow-1 ms-4">
                            <h4 class="card-title mb-0">Generate Plots</h4>
                          </div>
                        </div>
                      </div>
                      <!-- End Col -->

                      <div class="col-sm-7 col-md-6">
                        <p class="card-text small">Visualise load flow results in different plot types</p>
                      </div>
                      <!-- End Col -->

                      <div class="col-12 col-lg-2 mt-3 mt-lg-0">
                        <div class="d-grid">
                          <button class="btn btn-outline-primary" type="button" onclick="generatePlots()">Launch</button>
                        </div>
                      </div>
                      <!-- End Col -->
                    </div>
                    <!-- End Row -->
                  </div>
                </div>
                <!-- End Card -->

                <!-- Card -->
                <div class="card card-sm card-bordered shadow-none">
                  <div class="card-body">
                    <div class="row align-items-sm-center">
                      <div class="col">
                        <div class="d-flex align-items-center">
                          <div class="flex-shrink-0">
                            <span class="svg-icon text-center text-primary d-flex align-items-center justify-content-center" style="min-width: 3rem; height: 3rem;">
                              <img src="{{ url_for('static', filename='images/icons/TransmissionLine.png') }}" alt="Visualise Map" class="result-icon">
                            </span>
                          </div>

                          <div class="flex-grow-1 ms-4">
                            <h4 class="card-title mb-0">Visualise Map</h4>
                          </div>
                        </div>
                      </div>
                      <!-- End Col -->

                      <div class="col-sm-7 col-md-6">
                        <p class="card-text small">Visualise voltage and current loadings in dynamic geographic format</p>
                      </div>
                      <!-- End Col -->

                      <div class="col-12 col-lg-2 mt-3 mt-lg-0">
                        <div class="d-grid">
                          <button class="btn btn-outline-primary" type="button" onclick="visualiseMap()">Launch</button>
                        </div>
                      </div>
                      <!-- End Col -->
                    </div>
                    <!-- End Row -->
                  </div>
                </div>
                <!-- End Card -->

                <!-- Card -->
                <div class="card card-sm card-bordered shadow-none">
                  <div class="card-body">
                    <div class="row align-items-sm-center">
                      <div class="col">
                        <div class="d-flex align-items-center">
                          <div class="flex-shrink-0">
                            <span class="svg-icon text-center text-primary d-flex align-items-center justify-content-center" style="min-width: 3rem; height: 3rem;">
                              <img src="{{ url_for('static', filename='images/icons/LoadFlow2.png') }}" alt="Generate Report" class="result-icon">
                            </span>
                          </div>

                          <div class="flex-grow-1 ms-4">
                            <h4 class="card-title mb-0">Generate Report</h4>
                          </div>
                        </div>
                      </div>
                      <!-- End Col -->

                      <div class="col-sm-7 col-md-6">
                        <p class="card-text small">Generate and download loadflow report</p>
                      </div>
                      <!-- End Col -->

                      <div class="col-12 col-lg-2 mt-3 mt-lg-0">
                        <div class="d-grid">
                          <button class="btn btn-outline-primary" type="button" onclick="generateReport()">Launch</button>
                        </div>
                      </div>
                      <!-- End Col -->
                    </div>
                    <!-- End Row -->
                  </div>
                </div>
                <!-- End Card -->
              </div>

              <!-- Card Info -->
              <div class="text-center">
                <div class="card card-info-link card-sm">
                  <div class="card-body">
                    Need custom visualization? <a class="card-link ms-2" href="#">Contact us <span class="bi-chevron-right small ms-1"></span></a>
                  </div>
                </div>
              </div>
              <!-- End Card Info -->
            </form>
            <!-- End Form -->
          </div>
        </div>
        <!-- End Tab Content -->
      </div>
    </div>
    <!-- End Col -->
  </div>
  <!-- End Row -->
</div>
<!-- End Content -->

<!-- End Content -->
 <!-- Three.js and Loadflow Background -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.158.0/build/three.min.js"></script>
    <script type="module" src="{{ url_for('static', filename='js/metaballsloadflow.js') }}"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Load Flow Workflow JavaScript
        let selectedEngine = null;
        let engineInitialized = false;
        let engineConfigured = false;

        function selectEngine(engine) {
            selectedEngine = engine;
            
            // Update button states
            document.querySelectorAll('.engine-select-btn').forEach(btn => {
                btn.classList.remove('btn-primary');
                btn.classList.add('btn-outline-primary');
            });
            
            // Highlight selected engine
            document.querySelector(`[data-engine="${engine}"]`).classList.remove('btn-outline-primary');
            document.querySelector(`[data-engine="${engine}"]`).classList.add('btn-primary');
            
            // Show step 2
            document.getElementById('step-engine-init').classList.remove('d-none');
            document.getElementById('selected-engine-name').textContent = engine.toUpperCase();
            
            // Reset subsequent steps
            resetSteps([3, 4]);
        }

        function initializeEngine() {
            if (!selectedEngine) return;
            
            // Show loading state
            document.getElementById('engine-status-indicator').classList.remove('d-none');
            document.getElementById('init-engine-btn').disabled = true;
            document.getElementById('status-text').textContent = `Initializing ${selectedEngine.toUpperCase()}...`;
            
            // API call to initialize engine
            fetch('/api/initialize-engine', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ engine: selectedEngine })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    engineInitialized = true;
                    document.getElementById('init-spinner').classList.add('d-none');
                    document.getElementById('status-text').innerHTML = '<i class="bi-check-circle text-success me-1"></i>' + data.message;
                    document.getElementById('engine-status').textContent = 'Initialized';
                    
                    // Show step 3
                    setTimeout(() => {
                        document.getElementById('step-engine-config').classList.remove('d-none');
                        if (selectedEngine === 'ipsa') {
                            document.getElementById('ipsa-config').classList.remove('d-none');
                        } else {
                            document.getElementById('powerfactory-config').classList.remove('d-none');
                        }
                    }, 1000);
                } else {
                    document.getElementById('init-spinner').classList.add('d-none');
                    document.getElementById('status-text').innerHTML = '<i class="bi-x-circle text-danger me-1"></i>' + data.message;
                    document.getElementById('init-engine-btn').disabled = false;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('init-spinner').classList.add('d-none');
                document.getElementById('status-text').innerHTML = '<i class="bi-x-circle text-danger me-1"></i>Connection error';
                document.getElementById('init-engine-btn').disabled = false;
            });
        }

        function loadIPSAFile() {
            const filePath = document.getElementById('ipsa-file-path').value;
            if (!filePath) {
                alert('Please enter a file path');
                return;
            }
            
            document.getElementById('load-ipsa-btn').disabled = true;
            document.getElementById('load-ipsa-btn').innerHTML = '<i class="bi-hourglass-split me-2"></i>Loading...';
            
            // API call to load IPSA file
            fetch('/api/load-ipsa-file', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ file_path: filePath })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    engineConfigured = true;
                    document.getElementById('load-ipsa-btn').innerHTML = '<i class="bi-check-circle me-2"></i>File Loaded';
                    document.getElementById('load-ipsa-btn').classList.remove('btn-success');
                    document.getElementById('load-ipsa-btn').classList.add('btn-outline-success');
                    
                    // Show step 4
                    document.getElementById('step-run-analysis').classList.remove('d-none');
                } else {
                    document.getElementById('load-ipsa-btn').innerHTML = '<i class="bi-x-circle me-2"></i>' + data.message;
                    document.getElementById('load-ipsa-btn').classList.remove('btn-success');
                    document.getElementById('load-ipsa-btn').classList.add('btn-danger');
                    document.getElementById('load-ipsa-btn').disabled = false;
                    
                    setTimeout(() => {
                        document.getElementById('load-ipsa-btn').innerHTML = '<i class="bi-file-earmark-check me-2"></i>Load IPSA File';
                        document.getElementById('load-ipsa-btn').classList.remove('btn-danger');
                        document.getElementById('load-ipsa-btn').classList.add('btn-success');
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('load-ipsa-btn').innerHTML = '<i class="bi-x-circle me-2"></i>Connection Error';
                document.getElementById('load-ipsa-btn').classList.remove('btn-success');
                document.getElementById('load-ipsa-btn').classList.add('btn-danger');
                document.getElementById('load-ipsa-btn').disabled = false;
                
                setTimeout(() => {
                    document.getElementById('load-ipsa-btn').innerHTML = '<i class="bi-file-earmark-check me-2"></i>Load IPSA File';
                    document.getElementById('load-ipsa-btn').classList.remove('btn-danger');
                    document.getElementById('load-ipsa-btn').classList.add('btn-success');
                }, 3000);
            });
        }

        function configurePowerFactory() {
            document.getElementById('config-pf-btn').disabled = true;
            document.getElementById('config-pf-btn').innerHTML = '<i class="bi-hourglass-split me-2"></i>Configuring...';
            
            setTimeout(() => {
                engineConfigured = true;
                document.getElementById('config-pf-btn').innerHTML = '<i class="bi-check-circle me-2"></i>Configured';
                document.getElementById('config-pf-btn').classList.remove('btn-success');
                document.getElementById('config-pf-btn').classList.add('btn-outline-success');
                
                // Show step 4
                document.getElementById('step-run-analysis').classList.remove('d-none');
            }, 1000);
        }

        function runLoadFlowAnalysis() {
            if (!engineInitialized || !engineConfigured) {
                alert('Please complete all configuration steps first');
                return;
            }
            
            // Hide step 4 and show progress
            document.getElementById('step-run-analysis').classList.add('d-none');
            document.getElementById('step-analysis-progress').classList.remove('d-none');
            
            // API call to run load flow analysis
            fetch('/api/run-loadflow', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ engine: selectedEngine })
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('step-analysis-progress').classList.add('d-none');
                
                if (data.success) {
                    alert('Load flow analysis completed successfully! Results will be shown in the Review Results tab.');
                    
                    // Switch to Review Results tab
                    document.getElementById('featuresThree-tab').click();
                } else {
                    alert('Analysis failed: ' + data.message);
                    // Show step 4 again
                    document.getElementById('step-run-analysis').classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('step-analysis-progress').classList.add('d-none');
                alert('Connection error occurred during analysis');
                // Show step 4 again
                document.getElementById('step-run-analysis').classList.remove('d-none');
            });
        }

        function browseFile() {
            // This would typically open a file dialog
            // For now, we'll simulate it
            const samplePath = "C:\\Path\\To\\Your\\IPSA\\File.xml";
            document.getElementById('ipsa-file-path').value = samplePath;
        }

        function resetSteps(stepNumbers) {
            stepNumbers.forEach(stepNum => {
                if (stepNum === 3) {
                    document.getElementById('step-engine-config').classList.add('d-none');
                    document.getElementById('ipsa-config').classList.add('d-none');
                    document.getElementById('powerfactory-config').classList.add('d-none');
                    engineConfigured = false;
                }
                if (stepNum === 4) {
                    document.getElementById('step-run-analysis').classList.add('d-none');
                    document.getElementById('step-analysis-progress').classList.add('d-none');
                }
            });
        }

        // Results Visualization Functions
        function generatePlots() {
            // TODO: Implement plot generation functionality
            alert('Generate Plots functionality will open various chart types for load flow results visualization');
        }

        function visualiseMap() {
            // TODO: Implement map visualization functionality
            alert('Visualise Map functionality will display network topology with voltage and current loadings on a geographic map');
        }

        function generateReport() {
            // TODO: Implement report generation functionality
            alert('Generate Report functionality will create and download a comprehensive load flow analysis report');
        }
    </script>
</body>
</html>